

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyfurnace.design.core.strand &mdash; pyFuRNAce 0.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=bbaf98b3"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            pyFuRNAce
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#web-application">Web Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#using-the-python-api">Using the Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#citation">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">Script API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">pyFuRNAce</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyfurnace.design.core.strand</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyfurnace.design.core.strand</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">oxDNA_analysis_tools.UTILS.RyeReader</span> <span class="kn">import</span> <span class="n">get_confs</span><span class="p">,</span> <span class="n">describe</span><span class="p">,</span> <span class="n">strand_describe</span><span class="p">,</span> <span class="n">inbox</span>
    <span class="kn">from</span> <span class="nn">oxDNA_analysis_tools.oxDNA_PDB</span> <span class="kn">import</span> <span class="n">oxDNA_PDB</span>
    <span class="n">oat_installed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">oat_installed</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">.symbols</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.callback</span> <span class="kn">import</span> <span class="n">Callback</span>
<span class="kn">from</span> <span class="nn">.position</span> <span class="kn">import</span> <span class="n">Position</span><span class="p">,</span> <span class="n">Direction</span>
<span class="kn">from</span> <span class="nn">.sequence</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">.coordinates_3d</span> <span class="kn">import</span> <span class="n">Coords</span>


<div class="viewcode-block" id="Strand">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand">[docs]</a>
<span class="k">class</span> <span class="nc">Strand</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a single RNA strand in a hybrid 1D/2D/3D representation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    strand : str, optional</span>
<span class="sd">        The strand text characters (default is empty).</span>
<span class="sd">    directionality : {&#39;53&#39;, &#39;35&#39;}, optional</span>
<span class="sd">        The directionality of the strand (default is &#39;53&#39;).</span>
<span class="sd">    start : Position, optional</span>
<span class="sd">        The starting position of the strand in 2D space (default is Position.zero()).</span>
<span class="sd">        If set to &#39;minimal&#39;, the start position is calculated as the minimal</span>
<span class="sd">        start position required to draw the strand in 2D to avoid negative coordinates.</span>
<span class="sd">    direction : Direction, optional</span>
<span class="sd">        The initial direction of the strand in 2D space (default is Direction.RIGHT).</span>
<span class="sd">    coords : Coords, optional</span>
<span class="sd">        The 3D coordinates for the strand (if not provided, they will be calculated).</span>
<span class="sd">    strands_block : StrandsBlock, optional</span>
<span class="sd">        The block of strands to which the strand belongs.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Arbitrary keyword arguments passed to the Callback class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : Coords</span>
<span class="sd">        The 3D coordinates for the strand.</span>
<span class="sd">    direction : Direction</span>
<span class="sd">        The direction of the strand in 2D space.</span>
<span class="sd">    directionality : str</span>
<span class="sd">        The directionality of the sequence (&#39;53&#39; or &#39;35&#39;).</span>
<span class="sd">    directions : Tuple[Direction]</span>
<span class="sd">        The directions of each strand character in 2D space (x,y coordinates).</span>
<span class="sd">    end : Position</span>
<span class="sd">        The last position of the strand in 2D space.</span>
<span class="sd">    end_direction : Direction</span>
<span class="sd">        The last direction of the strand in 2D space.</span>
<span class="sd">    max_pos : Position</span>
<span class="sd">        The maximum x, y coordinates of the strand in 2D space.</span>
<span class="sd">    min_pos : Position</span>
<span class="sd">        The minimum x, y coordinates of the strand in 2D space.</span>
<span class="sd">    minimal_dimensions : Position</span>
<span class="sd">        The minimum start Positions required to draw the strand in 2D</span>
<span class="sd">        without reaching negative positions.</span>
<span class="sd">        Calculating the minimal dimensions doesn&#39;t take into</span>
<span class="sd">        acount structural errors.</span>
<span class="sd">    next_pos : Position</span>
<span class="sd">        The next position of the strand in 2D space.</span>
<span class="sd">    pk_info : Optional[Dict]</span>
<span class="sd">        The pseudoknot information of the strand (if any).</span>
<span class="sd">    positions : Tuple[Position]</span>
<span class="sd">        The positions of each strand character in 2D space (x,y coordinates).</span>
<span class="sd">    prec_pos : Position</span>
<span class="sd">        The preceding position of the strand in 2D space.</span>
<span class="sd">    seq_positions : Tuple[Position]</span>
<span class="sd">        The positions of each nucleotide in the strand sequence (x,y coordinates).</span>
<span class="sd">    sequence : Sequence</span>
<span class="sd">        The nucleotide sequence of the strand.</span>
<span class="sd">    sequence_list : List[Sequence]</span>
<span class="sd">        The list of consecutive sequences in the strand.</span>
<span class="sd">    sequence_slice : List[slice]</span>
<span class="sd">        The list of slices of the sequence in the strand.</span>
<span class="sd">    start : Position</span>
<span class="sd">        The starting position of the strand.</span>
<span class="sd">    strand : str</span>
<span class="sd">        The strand string representation.</span>
<span class="sd">    strands_block : StrandsBlock</span>
<span class="sd">        The block of strands to which the strand belongs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">strand</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                 <span class="n">directionality</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;53&#39;</span><span class="p">,</span> <span class="s1">&#39;35&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;53&#39;</span><span class="p">,</span> 
                 <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;minimal&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">direction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Direction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">coords</span><span class="p">:</span> <span class="n">Coords</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">strands_block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;StrandsBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Strand object with given properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strand : str, optional</span>
<span class="sd">            The characters strand representation (default is empty).</span>
<span class="sd">        directionality : {&#39;53&#39;, &#39;35&#39;}, </span>
<span class="sd">            The directionality of the strand (default is &#39;53&#39;).</span>
<span class="sd">        start : Position, default Position.zero()</span>
<span class="sd">            The starting position of the strand in 2D space.</span>
<span class="sd">            If start is set to &#39;minimal&#39;, the start position is calculated</span>
<span class="sd">            as the minimal start position required to draw the strand in 2D</span>
<span class="sd">            to avoid negative coordinates.</span>
<span class="sd">        direction : Direction, default is Direction.RIGHT</span>
<span class="sd">            The initial direction of the strand in 2D space.</span>
<span class="sd">        coords : Coords, optional</span>
<span class="sd">            The 3D coordinates for the strand.</span>
<span class="sd">        strands_block : StrandsBlock, optional</span>
<span class="sd">            The block of strands to which the strand belongs.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Arbitrary keyword arguments passed to the Callback class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># register the callback</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_pos</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_line</span><span class="p">(</span><span class="n">strand</span><span class="p">)</span>

        <span class="c1"># Set the strand and sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_sequence_insertion</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span> <span class="n">directionality</span><span class="p">)</span>

        <span class="c1">### check the 2D direction </span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">RIGHT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1">### check the start position</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">Position</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;minimal&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_dimensions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="c1">### set 2D properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>

        <span class="c1"># set the strand block to lock the 3D coordinates</span>
        <span class="k">if</span> <span class="n">strands_block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strands_block</span> <span class="o">=</span> <span class="n">strands_block</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strands_block</span> <span class="o">=</span> <span class="n">StrandsBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a string representation of the Strand object. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a string representation of the Strand object. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the character at the given index. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">],</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the character at the given index in the strand. &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># convert to list to accept slice indexing and negative indexing</span>
        <span class="n">new_strand_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
        <span class="n">new_strand_line</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">new_strand_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strand_line</span><span class="p">)</span>
        <span class="c1">### update the strand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="n">new_strand_str</span> 

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="s1">&#39;Strand&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add two strands together, check the directionality. &quot;&quot;&quot;</span>
        <span class="c1"># check and copy the other strand</span>
        <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_addition</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="c1"># combine the 3D coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="o">.</span><span class="n">combine_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="c1"># create a new strand combined strand</span>
        <span class="n">new_strand</span> <span class="o">=</span> <span class="n">Strand</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directionality</span><span class="p">,</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> 
                            <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">,</span>
                            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
        
        <span class="c1"># combine the pseudoknots information and add them</span>
        <span class="n">new_strand</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_pk_info</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_strand</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="s1">&#39;Strand&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; In place addition of two strands together. &quot;&quot;&quot;</span>
        <span class="c1"># check and copy the other strand</span>
        <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_addition</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="c1"># add the strand to the current strand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">strand</span>
        <span class="c1"># combine the 3D coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="o">.</span><span class="n">combine_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

        <span class="c1"># combine the pseudoknots information and add them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_pk_info</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="c1"># notify the upper class that the strand has changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Right addition a Strand to a string or a Sequence. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_addition</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># the only accepted options are str and Sequence</span>
        <span class="k">return</span> <span class="n">Strand</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> 
                        <span class="n">directionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="p">,</span> 
                        <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> 
                        <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> 
                        <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the length of the strand. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check if two strands are equal, or if the strand is equal to a </span>
<span class="sd">        string or a Sequence. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">positions</span> 
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">directionality</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return true if the strand has strand characters. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check if a position or a substrand is included in the strand. &quot;&quot;&quot;</span>
        <span class="c1"># check a position (a tuple or list containing two integers)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
        <span class="c1"># check a substrand</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="c1"># zip the strand and the positions</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span>
            <span class="n">full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span>

            <span class="c1"># sliding window to check if the sub is in the full</span>
            <span class="n">sub_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="o">-</span> <span class="n">sub_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">full</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">sub_len</span><span class="p">]</span> <span class="o">==</span> <span class="n">sub</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                
            <span class="c1"># if not found, return False</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1">### </span>
    <span class="c1">### PROPERTIES</span>
    <span class="c1">###</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Coords</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The oxDNA 3D coordinates of the strand.</span>
<span class="sd">        If the coordinates are not set, they are calculated for a strand in</span>
<span class="sd">        a perfect helix with the same length of the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="o">.</span><span class="n">compute_helix_from_nucl</span><span class="p">(</span>
                            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># start position</span>
                            <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># base vector</span>
                            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># normal vector</span>
                            <span class="n">length</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">),</span>
                            <span class="n">directionality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="p">,</span>
                            <span class="n">double</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="k">return</span> <span class="n">coords</span>

    <span class="nd">@coords</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Coords</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the oxDNA 3D coordinates of the strand.</span>
<span class="sd">        Check the Coords documentation for the format of the coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_coords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="p">()</span>

        <span class="c1"># sanity check</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of oxDNA coordinates &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span><span class="si">}</span><span class="s2">) is different &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;from the number of nucleotides &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_coords</span><span class="p">,</span> <span class="n">Coords</span><span class="p">):</span>
            <span class="n">new_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">new_coords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Direction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The starting (x, y) 2D direction to build the strand in 2D. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span>

    <span class="nd">@direction</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Direction</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The starting direction setter: a tuple of x,y coordinates in which one</span>
<span class="sd">        coordinate is 0 and the other either 1 or -1. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">new_direction</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directionality</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;53&#39;</span><span class="p">,</span> <span class="s1">&#39;35&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The directionality of the sequence (&#39;53&#39; or &#39;35&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directionality</span>

    <span class="nd">@directionality</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">directionality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_directionality</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;53&#39;</span><span class="p">,</span> <span class="s1">&#39;35&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set the directionality of the sequence (&#39;53&#39; or &#39;35&#39;). </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_directionality</span> <span class="o">=</span> <span class="n">new_directionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Direction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        A tuple of the directions of each character of the strand in 2D space</span>
<span class="sd">        (x,y coordinates).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The last position of the strand: it is the last element of the positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Direction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The last direction of the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The maximum x, y coordinates of the strand in 2D space. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minimal_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The minimum start Positions required to draw the strand in 2D</span>
<span class="sd">        without reaching negative positions.</span>
<span class="sd">        Calculating the minimal dimensions doesn&#39;t take into</span>
<span class="sd">        acount structural errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize the start position</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">Position</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">Position</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>

        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># check that the structure does not reach negative coordinates, </span>
            <span class="c1"># in case add 1 to all negative positions</span>
            <span class="n">negative</span> <span class="o">=</span> <span class="n">Position</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">))</span>

            <span class="c1"># add +1 to the element that is negative</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">negative</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">negative</span>

            <span class="c1">### UPDATE DIRECTIONS ###</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╰╮</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">swap_xy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╭╯/&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">swap_xy_change_sign</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;⊗&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">+=</span> <span class="n">Position</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;⊙&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">-=</span> <span class="n">Position</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># else the direction is the same</span>

            <span class="c1"># calculate new position</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">direction</span>

        <span class="k">return</span> <span class="n">start</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The minimum x, y coordinates of the strand in 2D space. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The next position of the strand: it is the last position plus the</span>
<span class="sd">        end_direction. Useful for joining two strands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Position</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        A tuple of the positions of each character of the strand in 2D space</span>
<span class="sd">        (x,y coordinates).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prec_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The preceding position of the strand: it is the start position</span>
<span class="sd">        minus the direction. Useful for joining two strands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># i could calculate this as self.start - self.direction</span>
        <span class="c1"># but if there are no positions, they will be likely needed soon</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The complete sequence of the strand. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span>

    <span class="nd">@sequence</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_seq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set the sequence of the strand. </span>
<span class="sd">        If the sequence is a string, it is split into the sequences of the strand.</span>
<span class="sd">        If the new sequence is longer than the current sequence, the sequence is </span>
<span class="sd">        added at the end of the strand. </span>
<span class="sd">        The strands keeps the current directionality, indipendently from the</span>
<span class="sd">        directionality of the new sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_line</span><span class="p">(</span><span class="n">new_seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updated_sequence</span><span class="p">(</span><span class="n">new_seq</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequence_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The list of consecutive sequences in the strand. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span><span class="p">:</span> <span class="c1"># iterate over the slices of the sequence</span>
            <span class="n">seq_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">[</span><span class="n">sl</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq_list</span>

    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">sequence_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">slice</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The list of slices of the sequence in the strand. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">seq_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Position</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The positions of each nucleotide in the strand sequence (x,y coordinates).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_positions</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The strand text characters. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span>

    <span class="nd">@strand</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">strand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set the strand text characters. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the strand</span>
        <span class="n">new_strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_line</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>
        <span class="c1"># update the strand and the sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_sequence_insertion</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>
        <span class="c1"># update the positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>
        <span class="c1"># notify the upper class that the strand has changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Start position of the strand in the 2D representation. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>

    <span class="nd">@start</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Start position setter: check that the input is </span>
<span class="sd">        a Position/tuple of x,y coordinates. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">new_start</span><span class="p">)</span>
        <span class="c1"># reset the 2D maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strands_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StrandsBlock&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        The block of strands that has locked 3D coordinates</span>
<span class="sd">        transformation (their relative position in the 3D space</span>
<span class="sd">        doesn&#39;t change when joined to other strands).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strands_block</span>

    <span class="nd">@strands_block</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">strands_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;StrandsBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a new strands block to the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unlock this strand from the previous block</span>
        <span class="k">if</span> <span class="n">new_block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strands_block</span> <span class="o">=</span> <span class="n">StrandsBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># check if the new block is a StrandsBlock</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_block</span><span class="p">,</span> <span class="n">StrandsBlock</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The strands block must be a StrandsBlock object. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
        
        <span class="c1"># assign the new block to the strand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strands_block</span> <span class="o">=</span> <span class="n">new_block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strands_block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1">### </span>
    <span class="c1">### STATIC METHODS</span>
    <span class="c1">###</span>

<div class="viewcode-block" id="Strand.join_strands">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.join_strands">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">join_strands</span><span class="p">(</span><span class="n">strand1</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">,</span> <span class="n">strand2</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Strand&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join two strands together if they match in the right direction and have</span>
<span class="sd">        a compatible directionality. This also combines the pseudoknot information</span>
<span class="sd">        and the 3D coordinates of the strands (transforming the coordinates of the</span>
<span class="sd">        second strand to match the first strand extension). The directionality of </span>
<span class="sd">        the combined strand is taken from the first strand if it has a sequence,</span>
<span class="sd">        otherwise it is taken from the second strand. The callbacks of the first </span>
<span class="sd">        strand are used for the new strand. The strands block of the joined strand </span>
<span class="sd">        includes the strands blocks of both strands.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strand1 : Strand</span>
<span class="sd">            The first strand to join.</span>
<span class="sd">        strand2 : Strand</span>
<span class="sd">            The second strand to join.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[Strand]</span>
<span class="sd">            The joined strand if possible, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strand2</span><span class="p">,</span> <span class="n">Strand</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strand1</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The objects to join are not a Strand object, &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">strand2</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">strand2</span><span class="p">)</span><span class="si">}</span><span class="s1"> instead.&#39;</span><span class="p">)</span>
        
        <span class="c1">### LOAD THE STRAND EDGES </span>
        <span class="n">s1_start_prev</span> <span class="o">=</span> <span class="n">strand1</span><span class="o">.</span><span class="n">prec_pos</span>
        <span class="n">s1_end_next</span> <span class="o">=</span> <span class="n">strand1</span><span class="o">.</span><span class="n">next_pos</span>
        <span class="c1"># check also strand2 or we could have problems if the strand has one symbol</span>
        <span class="n">s2_start_prev</span> <span class="o">=</span> <span class="n">strand2</span><span class="o">.</span><span class="n">prec_pos</span>
        <span class="n">s2_end_next</span> <span class="o">=</span> <span class="n">strand2</span><span class="o">.</span><span class="n">next_pos</span>

        <span class="c1">### There are 4 case: </span>
        <span class="c1">#       in 2 case we have to invert the second strand</span>
        <span class="c1">#       in 2 case we can just add them</span>
        
        <span class="c1">### CHECK THE SECOND STRAND INVERSION</span>
        <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># case 1: (1)--&gt;,&lt;--(2)</span>
        <span class="k">if</span> <span class="n">s1_end_next</span> <span class="o">==</span> <span class="n">strand2</span><span class="o">.</span><span class="n">end</span> <span class="ow">and</span> <span class="n">s2_end_next</span> <span class="o">==</span> <span class="n">strand1</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="n">strand2</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># case 2: &lt;--(1),--&gt;(2)</span>
        <span class="k">elif</span> <span class="n">s1_start_prev</span> <span class="o">==</span> <span class="n">strand2</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">s2_start_prev</span> <span class="o">==</span> <span class="n">strand1</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">strand2</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1">### CHECK ADDITION AND JOINING</span>
        <span class="n">join_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># case 3: (1)--&gt;,--&gt;(2)</span>
        <span class="k">if</span> <span class="n">s1_end_next</span> <span class="o">==</span> <span class="n">strand2</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">join_order</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># case 4: &lt;--(1),&lt;--(2)</span>
        <span class="k">elif</span> <span class="n">s1_start_prev</span> <span class="o">==</span> <span class="n">strand2</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="n">join_order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># join them in the order found</span>
        <span class="k">if</span> <span class="n">join_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">strand1</span><span class="o">.</span><span class="n">_check_addition</span><span class="p">(</span><span class="n">strand2</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
            
            <span class="k">if</span> <span class="n">join_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">strand1</span><span class="p">,</span> <span class="n">strand2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">strand2</span><span class="p">,</span> <span class="n">strand1</span>

            <span class="c1"># join the coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="o">.</span><span class="n">combine_coords</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
            
            <span class="c1"># set the directionality of the strand with the sequence</span>
            <span class="c1"># always priority to strand1</span>
            <span class="n">directionality</span> <span class="o">=</span> <span class="n">strand1</span><span class="o">.</span><span class="n">directionality</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">strand1</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
                <span class="n">directionality</span> <span class="o">=</span> <span class="n">strand2</span><span class="o">.</span><span class="n">directionality</span>

            <span class="c1"># create a new joined strand</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="n">Strand</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">strand</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> 
                            <span class="n">directionality</span><span class="o">=</span><span class="n">directionality</span><span class="p">,</span> 
                            <span class="n">start</span><span class="o">=</span><span class="n">first</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> 
                            <span class="n">direction</span><span class="o">=</span><span class="n">first</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> 
                            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> 
                            <span class="c1"># always priority to strand1 callbacks</span>
                            <span class="n">callbacks</span><span class="o">=</span><span class="n">strand1</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>
            
            <span class="c1"># update the positional parameters</span>
            <span class="k">if</span> <span class="n">strand1</span><span class="o">.</span><span class="n">_positions</span> <span class="ow">and</span> <span class="n">strand2</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_positions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_positions</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_directions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_directions</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_seq_positions</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_prec_pos</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_prec_pos</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">=</span> <span class="n">second</span><span class="o">.</span><span class="n">_next_pos</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_max_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                           <span class="nb">max</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">joined</span><span class="o">.</span><span class="n">_min_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                           <span class="nb">min</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            
            <span class="c1"># update the pseudoknots information</span>
            <span class="n">joined</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_combine_pk_info</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

        <span class="c1"># revert back the strand if it was inverted</span>
        <span class="k">if</span> <span class="n">s2_inverted</span><span class="p">:</span>
            <span class="n">strand2</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>

        <span class="c1"># check if the strand is empty</span>
        <span class="k">if</span> <span class="n">joined</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># join the strands block of the combined and first strand</span>
        <span class="n">joined</span><span class="o">.</span><span class="n">strands_block</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">strand1</span><span class="o">.</span><span class="n">strands_block</span><span class="p">,</span>
                                    <span class="n">strand2</span><span class="o">.</span><span class="n">strands_block</span><span class="p">,</span>
                                    <span class="n">avoid_strands</span><span class="o">=</span><span class="p">{</span><span class="n">strand1</span><span class="p">,</span> <span class="n">strand2</span><span class="p">}</span>
                                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">joined</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_position</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Check that the input is a valid position or direction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_pos_dir : Union[Position, tuple, list]</span>
<span class="sd">            The input position or direction to check.</span>
<span class="sd">        direction : bool, default False</span>
<span class="sd">            If True, check if the input is a direction (a tuple with one coordinate</span>
<span class="sd">            equal to 0 and the other either 1 or -1).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Position</span>
<span class="sd">            The input position or direction as a Position object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">,</span> <span class="p">(</span><span class="n">Direction</span><span class="p">,</span> <span class="n">Position</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">input_pos_dir</span> 
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> 
                <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The 2D coordinates must be a tuple/list of (x,y) &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;integer values. Got </span><span class="si">{</span><span class="n">input_pos_dir</span><span class="si">}</span><span class="s1"> instead.&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">})</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;2D direction not allowed. The allowed values are:</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;RIGHT (1, 0); DOWN (0, 1); LEFT (-1, 0); UP (0, -1).</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="n">input_pos_dir</span><span class="si">}</span><span class="s1"> instead.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Position</span><span class="p">(</span><span class="n">input_pos_dir</span><span class="p">)</span>

    <span class="c1">###</span>
    <span class="c1">### PROTECTED METHODS</span>
    <span class="c1">###</span>

    <span class="k">def</span> <span class="nf">_calculate_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Trace the strand in 2D space and create the 2D properties of the strand.</span>
<span class="sd">        It cleans the symbols, replacing them with the corresponding nice ASCII </span>
<span class="sd">        representation. It also checks for structural errors in the strand</span>
<span class="sd">        drawing.</span>
<span class="sd">        This function calculates the properties:</span>
<span class="sd">            - _prec_pos</span>
<span class="sd">            - _positions</span>
<span class="sd">            - _directions</span>
<span class="sd">            - _next_pos</span>
<span class="sd">            - _max_pos</span>
<span class="sd">            - _min_pos</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        MotifStructureError</span>
<span class="sd">            If the strand has structural errors in the 2D representation.</span>
<span class="sd">            (e.g. negative coordinates, wrong symbols, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### initialize all the variables</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">min_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">direction</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># pos_set = set() # to check weird crossings</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="n">direction</span><span class="p">]</span>
        <span class="n">seq_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Use list for efficient string concatenation</span>
        <span class="n">new_strand</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="c1"># first conversion of the symbols that are easy to interpret</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">symb_to_road</span><span class="p">)</span>

        <span class="c1"># initialize the error message</span>
        <span class="n">xy_error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The </span><span class="si">{xy_axis}</span><span class="s2"> direction of the strand (d</span><span class="si">{xy_axis}</span><span class="s2">: </span><span class="si">{dir_xy}</span><span class="s2">)&quot;</span>
                        <span class="s2">&quot; is not compatible with the next symbol (</span><span class="si">{cur_sym}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Current strand: </span><span class="si">{cur_strand}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Full strand: </span><span class="si">{full_strand}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># traverse the strand building the 2D map</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">translated</span><span class="p">):</span>

            <span class="c1"># Convert the turns to the corresponding symbols</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;╭&#39;</span>
                <span class="k">elif</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;╯&#39;</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;╮&#39;</span>
                <span class="k">elif</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;╰&#39;</span>
            <span class="c1"># conver the up and down symbols to match the directionality</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;↓&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span> <span class="o">==</span> <span class="s1">&#39;53&#39;</span> <span class="ow">or</span>\
                    <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span> <span class="o">==</span> <span class="s1">&#39;35&#39;</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;↑&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;↓&#39;</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">nucleotides</span><span class="p">:</span>
                <span class="c1"># add the base positions</span>
                <span class="n">seq_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

            <span class="c1"># Append the new symbol to the strand list</span>
            <span class="n">new_strand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>

            <span class="c1"># Check for invalid positions and raise error early</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The strand reaches negative coordinates: &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">. The current positions are: &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">positions</span><span class="si">}</span><span class="s2">.&quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot; The last direction is: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">. &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;Current strand: </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            
            <span class="c1"># Check symbols and directions errors</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;│&quot;</span><span class="p">,</span> 
                             <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╰╭&quot;</span><span class="p">,</span> 
                             <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╮╯&quot;</span><span class="p">))):</span>
                <span class="n">cur_strand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="n">xy_error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xy_axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> 
                                                              <span class="n">dir_xy</span><span class="o">=</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                              <span class="n">cur_sym</span><span class="o">=</span><span class="n">sym</span><span class="p">,</span> 
                                                              <span class="n">cur_strand</span><span class="o">=</span><span class="n">cur_strand</span><span class="p">,</span>
                                                              <span class="n">full_strand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span>
                                                              <span class="p">)</span>
                                          <span class="p">)</span>
            
            <span class="k">elif</span> <span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;─&quot;</span><span class="p">,</span> 
                             <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╭╮&quot;</span><span class="p">,</span> 
                             <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╰╯&quot;</span><span class="p">))):</span>
                <span class="n">cur_strand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="n">xy_error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xy_axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> 
                                                              <span class="n">dir_xy</span><span class="o">=</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                              <span class="n">cur_sym</span><span class="o">=</span><span class="n">sym</span><span class="p">,</span> 
                                                              <span class="n">cur_strand</span><span class="o">=</span><span class="n">cur_strand</span><span class="p">,</span>
                                                              <span class="n">full_strand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span>
                                                              <span class="p">)</span>
                                          <span class="p">)</span>
            
            <span class="c1">### DON&#39;T NAME THE CROSSINGS IF THEY WORKS</span>
            <span class="c1"># allowed crossing, signal it</span>
            <span class="k">elif</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;┼&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The strand is doing a crossing not allowed, &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&#39; is trying to overwrite the symbol at position&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&#39;. The symbol will be overwritten &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;with &#39;┼&#39;.&quot;</span><span class="p">,</span> <span class="n">AmbiguosStructure</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="s1">&#39;┼&#39;</span>
                <span class="n">new_strand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym</span>

            <span class="c1"># Add symbol to the 2D map</span>
            <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Update directions</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╰╮</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">swap_xy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="ow">in</span> <span class="s2">&quot;╭╯/&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">swap_change_sign_xy</span><span class="p">()</span>
            <span class="c1"># EXPERIMENTAL</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;⊗&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">+</span> <span class="n">Position</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">sym</span> <span class="o">==</span> <span class="s2">&quot;⊙&quot;</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">-</span> <span class="n">Position</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">directions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

            <span class="c1"># Update positions</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">direction</span>

        <span class="c1"># Update the strand symbols</span>
        <span class="n">new_strand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">!=</span> <span class="n">new_strand</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="n">new_strand</span>
        
        <span class="c1"># Update the 2D properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">seq_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span><span class="n">max_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span><span class="n">min_pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                        <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="s1">&#39;Strand&#39;</span><span class="p">],</span> 
                        <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check a second object for addition to the strand.</span>
<span class="sd">        If the object is a string or Sequence, it is converted to a Strand object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : Union[str, Sequence, Strand]</span>
<span class="sd">            The object to check for addition.</span>
<span class="sd">        copy : bool, default True</span>
<span class="sd">            If True, return a copy of the object. </span>
<span class="sd">            If False, return the object itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand</span>
<span class="sd">            The object to add to the strand.</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the object is not a valid type for addition.</span>
<span class="sd">        MotifStructureError</span>
<span class="sd">            If the strand has structural errors in the 2D representation.</span>
<span class="sd">            (e.g. different directionality, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># + str</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Strand</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directionality</span><span class="p">)</span>
        
        <span class="c1"># + Sequence error</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> 
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> 
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directionality</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">directionality</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot add a strand with a Sequence with &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;different directionality.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Strand: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="si">}</span><span class="s1">. </span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Strand directionality: &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sequence: </span><span class="si">{</span><span class="n">other</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sequence directionality: &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">directionality</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># + Sequence no error</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Strand</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="p">)</span>
        
        <span class="c1"># + Not a strand</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">other</span><span class="si">}</span><span class="s1"> is not a valid type for addition&#39;</span><span class="p">)</span>
        
        <span class="c1"># + Strand error</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">sequence</span> 
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">directionality</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot add two strands with different &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;directionality. </span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">First strand: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">First strand directionality: &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">directionality</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Second strand </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">_strand</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Second strand directionality: &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">directionality</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_check_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                    <span class="n">line</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">],</span>
                    <span class="n">translator</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">symb_to_none</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the input is a valid strand or sequence.</span>
<span class="sd">        The translator is used to check the symbols in the line</span>
<span class="sd">        are valid for the strand (translator: symb_to_none) or</span>
<span class="sd">        valid for the sequence (translator: nucl_to_none).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line : Union[str, Sequence]</span>
<span class="sd">            The input strand to check.</span>
<span class="sd">        translator : Dict, default symb_to_none</span>
<span class="sd">            The translator dictionary to check the strand symbols.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the input is not a valid strand or sequence.</span>
<span class="sd">        MotifStructureError</span>
<span class="sd">            If the strand has structural errors in the 2D representation.</span>
<span class="sd">            (e.g. terminal symbols in the middle of the strand, etc.)</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the input contains invalid symbols for the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># all good for Sequences</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">_sequence</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c1"># convert to uppercase</span>

        <span class="c1"># Not a string</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The strand must be a string or a sequence object. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check that the terminal symbols are not in the middle of the strand</span>
        <span class="k">for</span> <span class="n">term_sym</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">term_sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">term_sym</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The strand can have only one start and one&quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;end symbol (&#39;5&#39; and &#39;3&#39;). &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">term_sym</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">term_sym</span><span class="si">}</span><span class="s2">&#39; symbols.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">term_sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;5&#39; and &#39;3&#39; symbols are terminal &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;symbols. Got &#39;</span><span class="si">{</span><span class="n">term_sym</span><span class="si">}</span><span class="s2">&#39; end at index &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">term_sym</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; instead.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Full strand: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            
        <span class="n">allowed_symbols</span> <span class="o">=</span> <span class="n">accept_symbol</span>
        <span class="k">if</span> <span class="n">translator</span> <span class="o">==</span> <span class="n">nucl_to_none</span><span class="p">:</span>
            <span class="n">allowed_symbols</span> <span class="o">=</span> <span class="n">nucleotides</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translator</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The string &#39;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&#39; contains symbols not allowed in &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;ROAD. The symbols allowed are: </span><span class="si">{</span><span class="n">allowed_symbols</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_combine_pk_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine the pseudoknot information of two strands.</span>
<span class="sd">        If the strands have no pseudoknot information, return None.</span>
<span class="sd">        The pk_info is a dictionary with:</span>
<span class="sd">            - id: list of pseudoknot ids (with hyphen for complementarity)</span>
<span class="sd">            - ind_fwd: list of tuples with the first and last index </span>
<span class="sd">                        of the pseudoknot in the sequence</span>
<span class="sd">            - E: list of energies of the pseudoknots</span>
<span class="sd">            - dE: list of dE values of the pseudoknots</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : Strand</span>
<span class="sd">            The other strand to combine with.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[Dict]</span>
<span class="sd">            The combined pseudoknot information if available, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the strands have pseudoknot information</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">new_pk_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ind_fwd&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;dE&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">:</span>
            <span class="n">new_pk_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
            <span class="n">new_pk_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">new_pk_info</span><span class="p">[</span><span class="s1">&#39;ind_fwd&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> 
                                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;ind_fwd&#39;</span><span class="p">]]</span>
            <span class="n">new_pk_info</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
            <span class="n">new_pk_info</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;dE&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">new_pk_info</span>

    <span class="k">def</span> <span class="nf">_reset_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Reset the strand 2D properties: positions, directions and base positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Main positional parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_updated_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">new_sequence</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Callback function to update the sequence of the strand.</span>
<span class="sd">        It updates the sequence properties and the strand string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_sequence : str or Sequence, default None</span>
<span class="sd">            The new sequence to update.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Arbitrary keyword arguments passed to the Callback class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cerate a new sequence object and register the callback</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_sequence</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">new_sequence</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="n">new_sequence</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">directionality</span><span class="p">,</span> 
                                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_updated_sequence</span><span class="p">)</span>

        <span class="n">new_seq_str</span> <span class="o">=</span> <span class="n">new_sequence</span><span class="o">.</span><span class="n">_sequence</span>
        <span class="c1"># reset the coordinates if the sequence changed length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_seq_str</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="p">(())</span> <span class="c1"># reset the oxDNA coordinates</span>

        <span class="c1"># assign the new sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">new_sequence</span>
        <span class="n">build_strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">nucl_to_none</span><span class="p">)</span>
        <span class="n">seq_ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># iterate over the slices of the sequence</span>
        <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span><span class="p">:</span> 
            <span class="c1"># the length of the sequence slice</span>
            <span class="n">subseq_len</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">sl</span><span class="o">.</span><span class="n">start</span> 
            <span class="c1"># replace the sequence slice with the new sequence</span>
            <span class="n">build_strand</span> <span class="o">=</span> <span class="p">(</span><span class="n">build_strand</span><span class="p">[:</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> 
                            <span class="o">+</span> <span class="n">new_seq_str</span><span class="p">[</span><span class="n">seq_ind</span><span class="p">:</span> <span class="n">seq_ind</span> <span class="o">+</span> <span class="n">subseq_len</span><span class="p">]</span> 
                            <span class="o">+</span> <span class="n">build_strand</span><span class="p">[</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">:]</span>
                            <span class="p">)</span>
            <span class="n">seq_ind</span> <span class="o">+=</span> <span class="n">subseq_len</span>

        <span class="c1"># add the rest of the sequence if any</span>
        <span class="k">if</span> <span class="n">new_seq_str</span><span class="p">[</span><span class="n">seq_ind</span><span class="p">:]:</span>
            <span class="n">build_strand</span> <span class="o">+=</span> <span class="n">new_seq_str</span><span class="p">[</span><span class="n">seq_ind</span><span class="p">:]</span>
            <span class="c1"># this updates the positions too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>

        <span class="c1"># update the strand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="n">build_strand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_sequence_insertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                   <span class="n">strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                   <span class="n">directionality</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function takes a strands string and updates the properties of the strand,</span>
<span class="sd">        sequence and sequence slice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strand : str</span>
<span class="sd">            The strand string to update.</span>
<span class="sd">        directionality : str, default None</span>
<span class="sd">            The directionality of the strand. If None, it is taken from the</span>
<span class="sd">            current sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize the variables</span>
        <span class="n">strand_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strand</span><span class="p">)</span>
        <span class="n">new_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">current_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">seq_slice</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># iterate over the strand</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strand_str</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
            <span class="c1"># if the symbol is a nucleotide, add it to the current sequence</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">nucleotides</span><span class="p">:</span>
                <span class="n">current_sequence</span> <span class="o">+=</span> <span class="n">sym</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if the current sequence is not empty </span>
                <span class="c1"># and the current symbol is not a nucleotide, </span>
                <span class="c1"># add it to the sequence slice and reset the current sequence</span>
                <span class="k">if</span> <span class="n">current_sequence</span><span class="p">:</span>
                    <span class="n">new_sequence</span> <span class="o">+=</span> <span class="n">current_sequence</span>
                    <span class="n">seq_slice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">ind</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_sequence</span><span class="p">),</span> <span class="n">ind</span><span class="p">))</span>
                    <span class="n">current_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> 

        <span class="c1"># reset the oxDNA coordinates if the sequence is not the same</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_sequence</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="p">(())</span> 

        <span class="c1"># pick the directionality</span>
        <span class="k">if</span> <span class="n">directionality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">directionality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">directionality</span>

        <span class="c1"># assign the new sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="n">new_sequence</span><span class="p">,</span> 
                                  <span class="n">directionality</span><span class="p">,</span> 
                                  <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_updated_sequence</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span> <span class="o">=</span> <span class="n">seq_slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="n">strand_str</span>

    <span class="c1">### </span>
    <span class="c1">### METHODS</span>
    <span class="c1">###</span>

<div class="viewcode-block" id="Strand.copy">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of the current strand, including coordinates and attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        callback : callable, default None</span>
<span class="sd">            A callback function to be registered in the copied strand.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand</span>
<span class="sd">            A deep copy of the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### Initialize a new strand object</span>
        <span class="n">new_strand</span> <span class="o">=</span> <span class="n">Strand</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Strand</span><span class="p">)</span>
        
        <span class="c1"># attributes that are calculated fresh or immutable that</span>
        <span class="c1"># can be just reassigned</span>
        <span class="n">attr_to_copy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_strand&#39;</span><span class="p">,</span>  <span class="c1"># strand properties</span>
                        <span class="s1">&#39;_seq_slice&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_start&#39;</span><span class="p">,</span> <span class="c1"># 2D positions</span>
                        <span class="s1">&#39;_direction&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;_positions&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;_directions&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_seq_positions&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_prec_pos&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_next_pos&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_max_pos&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_min_pos&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attr_to_copy</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_strand</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

        <span class="c1"># sequence attributes</span>
        <span class="n">new_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">new_strand</span><span class="o">.</span><span class="n">_updated_sequence</span><span class="p">)</span>
        <span class="n">new_strand</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">new_seq</span>

        <span class="n">new_strand</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_strand</span><span class="o">.</span><span class="n">_strands_block</span> <span class="o">=</span> <span class="n">StrandsBlock</span><span class="p">(</span><span class="n">new_strand</span><span class="p">)</span>

        <span class="c1">### callbacks</span>
        <span class="n">new_strand</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">callback</span><span class="p">]</span> <span class="k">if</span> <span class="n">callback</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="c1">### pk_info</span>
        <span class="n">new_strand</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">new_strand</span></div>


<div class="viewcode-block" id="Strand.draw">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.draw">[docs]</a>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">canvas</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
             <span class="n">return_string</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
             <span class="n">plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw the strand in 2D space using a canvas.</span>
<span class="sd">        The canvas is a list of strings, where each string is a line of the canvas.</span>
<span class="sd">        The strand is drawn using the characters and positions of the strand.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        canvas : list, default None</span>
<span class="sd">            The canvas to draw the strand on. If None, a new canvas is created.</span>
<span class="sd">        return_string : bool, default True</span>
<span class="sd">            If True, return the drawn canvas as a string (for printing).</span>
<span class="sd">        plane : int, default 0</span>
<span class="sd">            The plane to draw the strand on (experimental). If 0, the strand </span>
<span class="sd">            is drawn in the default plane. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The drawn canvas as a string if return_string is True, otherwise None.</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        MotifStructureError</span>
<span class="sd">            If the canvas is not large enough to draw the strand or a position is</span>
<span class="sd">            trying to overwrite a symbol in the canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">],</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">],</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1">### CHECK THE CANVAS OR CREATE IT ACCORDING TO THE MAXIMUM POSITIONS </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span><span class="p">)]</span> <span class="o">*</span> <span class="n">max_y</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_y</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error while drawing the strands. The number &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;of lines in the canvas (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span><span class="si">}</span><span class="s1">) is &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;lower than the line required by the strand &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">max_y</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_x</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">canvas</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error while drawing the strands. The number &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;of line characters in the canvas &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">canvas</span><span class="p">]</span><span class="si">}</span><span class="s1">) &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;is lower than characters required by the &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;strand (</span><span class="si">{</span><span class="n">max_x</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        
        <span class="c1">### ADD A SYMBOL AND CHECK THE CANVAS </span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">):</span>

            <span class="c1"># experimental plane</span>
            <span class="k">if</span> <span class="n">plane</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">canv_sym</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="c1"># experimental plane</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">plane</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># the strand is crossing a symbol in the canvas</span>
            <span class="k">if</span> <span class="n">canv_sym</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span> <span class="ow">and</span> <span class="n">canv_sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;┼+&quot;</span> <span class="ow">and</span> <span class="n">sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;┼+&quot;</span><span class="p">:</span>
                <span class="n">current_canvas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MotifStructureError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while drawing the strands. &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&#39; at position </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2"> is trying&quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot; to overwrite the symbol &#39;</span><span class="si">{</span><span class="n">canv_sym</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;Current drawing: </span><span class="se">\n</span><span class="si">{</span><span class="n">current_canvas</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                          <span class="sa">f</span><span class="s2">&quot;Current strand: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># the symbol replace the space in the canvas</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">canvas</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][:</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
                                 <span class="o">+</span> <span class="n">sym</span> 
                                 <span class="o">+</span> <span class="n">canvas</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">return_string</span><span class="p">:</span> 
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Strand.flip">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.flip">[docs]</a>
    <span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">horizontally</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
             <span class="n">vertically</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
             <span class="n">flip_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flip the 2D structure of the strand. This affects the orientation on the </span>
<span class="sd">        canvas but does not revert the sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        horizontally : bool, default=True</span>
<span class="sd">            Whether to flip the strand horizontally (mirror along the y-axis).</span>
<span class="sd">        vertically : bool, default=False</span>
<span class="sd">            Whether to flip the strand vertically (mirror along the x-axis).</span>
<span class="sd">        flip_start : bool, default=True</span>
<span class="sd">            Whether to also flip the starting point of the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">flip_start</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>

            <span class="c1"># CALCULATE NEW START POSITION</span>
            <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>

            <span class="k">if</span> <span class="n">horizontally</span><span class="p">:</span>
                <span class="n">new_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vertically</span><span class="p">:</span>
                <span class="n">new_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">new_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_y</span><span class="p">)</span>

        <span class="c1"># CALCULATE NEW DIRECTION and update the strand sybols</span>
        <span class="k">if</span> <span class="n">horizontally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                      <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">horiz_flip</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">vertically</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                      <span class="n">y</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">verti_flip</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_positions</span><span class="p">()</span>
        <span class="c1"># trigger the callbacks only once</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span> </div>


<div class="viewcode-block" id="Strand.get_base_at_pos">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.get_base_at_pos">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the base at the specified 2D position in the strand.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : Position or tuple of int</span>
<span class="sd">            The position to get the base from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The base at the specified position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pos</span><span class="p">)])</span></div>


<div class="viewcode-block" id="Strand.get_char_at_pos">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.get_char_at_pos">[docs]</a>
    <span class="k">def</span> <span class="nf">get_char_at_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the character at the specified 2D position in the strand.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : Position or tuple of int</span>
<span class="sd">            The position to get the character from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The character at the specified position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pos</span><span class="p">)]</span></div>

    
<div class="viewcode-block" id="Strand.get_position_map">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.get_position_map">[docs]</a>
    <span class="k">def</span> <span class="nf">get_position_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dictionary of positions as keys and the corresponding</span>
<span class="sd">        characters as values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[Tuple[int, int], str]</span>
<span class="sd">            A dictionary mapping positions to characters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">pos</span><span class="p">:</span> <span class="n">char</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)}</span></div>


<div class="viewcode-block" id="Strand.insert">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.insert">[docs]</a>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a character into the strand at the specified index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            The index at which to insert the character.</span>
<span class="sd">        val : str</span>
<span class="sd">            The character(s) to insert into the strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_line</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">strand_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
        <span class="n">strand_line</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="c1"># this trigger the callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strand_line</span><span class="p">)</span> </div>


<div class="viewcode-block" id="Strand.invert">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.invert">[docs]</a>
    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert the start and end positions of the strand, </span>
<span class="sd">        effectively reversing the sequence directionalty</span>
<span class="sd">        and 3D coordinates orientation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand</span>
<span class="sd">            The updated strand instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t trigger the callbacks, the strand is the same for the Motif</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">strand_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

        <span class="c1"># update the start positions and direction</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># update the strand and sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strand</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">_directionality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">_directionality</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">_sequence</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">strand_len</span> <span class="o">-</span> <span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">strand_len</span> <span class="o">-</span> <span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_slice</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        
        <span class="c1"># invert the positions if already built</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span>
            <span class="c1"># max pos and min pos don&#39;t change</span>

        <span class="c1"># adjust the pseudoknots information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">:</span>
            <span class="n">new_ind_fwd</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;ind_fwd&#39;</span><span class="p">]:</span>
                <span class="n">new_ind_fwd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">seq_len</span> <span class="o">-</span> <span class="n">end</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span><span class="p">[</span><span class="s1">&#39;ind_fwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ind_fwd</span>

        <span class="c1"># update the 3D coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span><span class="o">.</span><span class="n">reverse_in_place</span><span class="p">()</span>
                
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Strand.join">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.join">[docs]</a>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">,</span> 
             <span class="n">trigger_callbacks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Strand&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join this strand with another strand, aligning their start and end </span>
<span class="sd">        positions and direction. This behaves like the @staticmethod join_strands, </span>
<span class="sd">        but it modifies the current strand instead of creating a new one. </span>
<span class="sd">        Check the join_strands method for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : Strand</span>
<span class="sd">            The other strand to join.</span>
<span class="sd">        trigger_callbacks : bool, default True</span>
<span class="sd">            If True, trigger the callbacks after joining the strands.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand or None</span>
<span class="sd">            The joined strand, or None if the strands cannot be joined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The object to join is not a Strand object,&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39; got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s1"> instead.&#39;</span><span class="p">)</span>
        <span class="c1"># load the edges of the strands</span>
        <span class="n">s1_start_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prec_pos</span>
        <span class="n">s1_end_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_pos</span>
        <span class="n">s2_start_prev</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">prec_pos</span>
        <span class="n">s2_end_next</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">next_pos</span>

        <span class="c1">### cases to invert the second strand</span>
        <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># case 1: (1)--&gt;,&lt;--(2)</span>
        <span class="k">if</span> <span class="n">s1_end_next</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">end</span> <span class="ow">and</span> <span class="n">s2_end_next</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># case 2: &lt;--(1),--&gt;(2)</span>
        <span class="k">elif</span> <span class="n">s1_start_prev</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">s2_start_prev</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
            <span class="n">s2_inverted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># now the strands are in the right position to be joined</span>
        <span class="c1">### case in which I can just add</span>
        <span class="n">join_order</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># case 3: (1)--&gt;,--&gt;(2)</span>
        <span class="k">if</span> <span class="n">s1_end_next</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">join_order</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># case 4: &lt;--(1),&lt;--(2)</span>
        <span class="k">elif</span> <span class="n">s1_start_prev</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
            <span class="n">join_order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">join_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_addition</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

            <span class="k">if</span> <span class="n">join_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">_directionality</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">directionality</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_direction</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="n">Coords</span><span class="o">.</span><span class="n">combine_coords</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

            <span class="c1"># this calls the reset of all the positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_sequence_insertion</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">strand</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">strands_block</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strands_block</span><span class="p">,</span> 
                                          <span class="n">other</span><span class="o">.</span><span class="n">strands_block</span><span class="p">,</span> 
                                          <span class="n">avoid_strands</span><span class="o">=</span><span class="p">{</span><span class="n">other</span><span class="p">}</span>
                                          <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">_positions</span> <span class="ow">and</span> <span class="n">second</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_positions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_positions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_directions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_directions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_directions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">_seq_positions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_prec_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">=</span> <span class="n">second</span><span class="o">.</span><span class="n">_next_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                         <span class="nb">max</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_min_pos</span> <span class="o">=</span> <span class="n">Position</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                         <span class="nb">min</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second</span><span class="o">.</span><span class="n">_min_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

            <span class="c1"># calculte the new pseudoknots information</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pk_info</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">_combine_pk_info</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        
        <span class="c1"># revert the strand to the original position</span>
        <span class="k">if</span> <span class="n">s2_inverted</span><span class="p">:</span> 
            <span class="n">other</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">join_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># trigger the callbacks if needed</span>
        <span class="k">if</span> <span class="n">trigger_callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Strand.pop">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.pop">[docs]</a>
    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove and return a character from the strand at the specified index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            The index of the character to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The removed character.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strand_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
        <span class="n">popped_val</span> <span class="o">=</span> <span class="n">strand_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strand_line</span><span class="p">)</span> <span class="c1"># this trigger the callbacks</span>
        <span class="k">return</span> <span class="n">popped_val</span></div>

 
<div class="viewcode-block" id="Strand.reverse">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.reverse">[docs]</a>
    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverse the directionality of the strand sequence </span>
<span class="sd">        (5&#39; to 3&#39; becomes 3&#39; to 5&#39; and vice versa).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand</span>
<span class="sd">            The updated strand instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Strand.save_3d_model">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.save_3d_model">[docs]</a>
    <span class="k">def</span> <span class="nf">save_3d_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                      <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;strand&#39;</span><span class="p">,</span> 
                      <span class="n">return_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                      <span class="n">pdb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the 3D structure of the strand in oxDNA format (.dat, .top)</span>
<span class="sd">        and optionally as PDB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, default=&#39;strand&#39;</span>
<span class="sd">            The base name for the output files.</span>
<span class="sd">        return_text : bool, default=False</span>
<span class="sd">            If True, returns the configuration and topology text instead </span>
<span class="sd">            of saving to file (used for real-time visualization).</span>
<span class="sd">        pdb : bool, default=False</span>
<span class="sd">            If True, exports the structure as a PDB file (requires </span>
<span class="sd">            `oxDNA_analysis_tools`).</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to the PDB export.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of str or None</span>
<span class="sd">            Returns (conf_text, top_text) if `return_text` is True, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### check for the sequence and directionality</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directionality</span> <span class="o">==</span> <span class="s1">&#39;53&#39;</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">### initialize the strand and nucleotide length</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">n_strands</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">### initialize the configuration and topology text</span>
        <span class="n">conf_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;t = 0</span><span class="se">\n</span><span class="s1">b = 100 100 100</span><span class="se">\n</span><span class="s1">E = 0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">top_text</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">+</span> <span class="s1">&#39; type=RNA circular=false </span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1">### Buil the configuration text</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">conf_text</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="c1">### ADD THE PROTEINS</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">proteins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a3</span> <span class="ow">in</span> <span class="n">protein</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">conf_text</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="c1">### ADD THE PROTEIN TO THE TOPOLOGY</span>
            <span class="n">top_text</span> <span class="o">+=</span> <span class="n">protein</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="s1">&#39; type=peptide circular=false </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">seq_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            <span class="n">n_strands</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">return_text</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conf_text</span><span class="p">,</span> <span class="n">top_text</span>

        <span class="c1">### write the oxDNA file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># remove the extension from the filename</span>
        <span class="n">conf_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.dat&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conf_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf_text</span><span class="p">)</span>

        <span class="c1">### write the top file</span>
        <span class="n">top_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.top&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">seq_len</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">n_strands</span><span class="si">}</span><span class="s1"> 5-&gt;3</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">top_text</span><span class="p">)</span>

        <span class="c1">### write the pdb file</span>
        <span class="k">if</span> <span class="n">pdb</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">oat_installed</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;oxDNA_analysis_tools is not installed. &quot;</span>
                              <span class="s2">&quot;Skipping PDB export.&quot;</span><span class="p">,</span> 
                              <span class="ne">UserWarning</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Read oxDNA configuration</span>
            <span class="n">system</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">strand_describe</span><span class="p">(</span><span class="n">top_file</span><span class="p">)</span>
            <span class="n">ti</span><span class="p">,</span> <span class="n">di</span> <span class="o">=</span> <span class="n">describe</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="n">conf_file</span><span class="p">)</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">get_confs</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">inbox</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">oxDNA_PDB</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Strand.shift">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.shift">[docs]</a>
    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
              <span class="n">shift_position</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Direction&#39;</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
              <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strand&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shift the strand position in the 2D layout.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shift_position : Position or Direction or tuple of int</span>
<span class="sd">            The shift to apply in x and y direction.</span>
<span class="sd">        check : bool, default True</span>
<span class="sd">            If True, check if the shift is valid (i.e. not negative coordinates).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Strand</span>
<span class="sd">            The updated strand instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_position</span><span class="p">(</span><span class="n">shift_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">+=</span> <span class="n">shift</span>

        <span class="c1"># don&#39;t update the positions if the strand is not built</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># apply the shift to all the positions</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">)</span>
        
        <span class="c1"># check if the shift is valid</span>
        <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">coor</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span> <span class="k">for</span> <span class="n">coor</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The strand reaches negative coordinates: &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;The positions would be: </span><span class="si">{</span><span class="n">positions</span><span class="si">}</span><span class="s1">.&#39;</span>
                             <span class="p">)</span>
        
        <span class="c1"># directly update the positional attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">shift</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_pos</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_pos</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_pos</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_pos</span> <span class="o">+=</span> <span class="n">shift</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_callbacks</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Strand.transform">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.Strand.transform">[docs]</a>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformation_matrix</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a transformation matrix to the strand&#39;s 3D coordinates.</span>
<span class="sd">        Check the Coords class for the transformation matrix format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transformation_matrix : array-like</span>
<span class="sd">            The transformation matrix to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformation_matrix</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StrandsBlock">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.StrandsBlock">[docs]</a>
<span class="k">class</span> <span class="nc">StrandsBlock</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container class that holds a collection of Strand instances.</span>

<span class="sd">    This class inherits from Python&#39;s built-in list and is designed to manage </span>
<span class="sd">    a group of Strand objects. It provides methods for adding, removing, </span>
<span class="sd">    joining, and transforming strands in the block.</span>
<span class="sd">    All the strands in the block have locked 3D coordinates respect to</span>
<span class="sd">    each other. This means that when a strand in the block is transformed,</span>
<span class="sd">    all the other strands in the block are transformed as well with the same</span>
<span class="sd">    transformation matrix. This is foundamental for managing 3D structures</span>
<span class="sd">    of motifs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : Strand</span>
<span class="sd">        Strand instances to be added to the block.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the list constructor.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    items : list</span>
<span class="sd">        The list of Strand instances stored in the block.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new StrandsBlock with Strand instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args : Strand</span>
<span class="sd">            Strand instances to be added to the block.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any of the input arguments is not an instance of Strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input arguments must be Strand instance&quot;</span><span class="p">)</span>   
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;StrandsBlock&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StrandsBlock&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate two StrandsBlock instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : StrandsBlock</span>
<span class="sd">            The StrandsBlock to be added.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        StrandsBlock</span>
<span class="sd">            A new StrandsBlock instance with the combined strands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StrandsBlock</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">array</span> <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>

<div class="viewcode-block" id="StrandsBlock.add">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.StrandsBlock.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a Strand instance to the StrandsBlock.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item : Strand</span>
<span class="sd">            The Strand instance to append.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the item is not an instance of Strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The item must be a Strand instance, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># append the strand to the block if it has coordinates</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">_strands_block</span> <span class="o">=</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="StrandsBlock.remove">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.StrandsBlock.remove">[docs]</a>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="s1">&#39;Strand&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a Strand instance from the StrandsBlock.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item : Strand</span>
<span class="sd">            The Strand instance to remove.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the item is not an instance of Strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Strand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The item must be a Strand instance, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">strands_block</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StrandsBlock.transform">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.StrandsBlock.transform">[docs]</a>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a transformation matrix to all the strands in the StrandsBlock.</span>
<span class="sd">        For the transformation matrix format, check the Coords class and its</span>
<span class="sd">        transform method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T : np.ndarray</span>
<span class="sd">            The transformation matrix to apply to each strand.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method assumes that the transformation matrix is compatible </span>
<span class="sd">        with the strand&#39;s coordinate system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">strand</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="StrandsBlock.update">
<a class="viewcode-back" href="../../../../pyfurnace.design.core.html#pyfurnace.design.core.strand.StrandsBlock.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
               <span class="o">*</span><span class="n">others</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StrandsBlock&#39;</span><span class="p">],</span>
               <span class="n">avoid_strands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="s1">&#39;Strand&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the strands block with the strands in the input iterable.</span>
<span class="sd">        This method is similar to the add method, but it allows for</span>
<span class="sd">        adding multiple strands at once. It also allows for avoiding</span>
<span class="sd">        specific strands in the update process.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *other : StrandsBlock</span>
<span class="sd">            The StrandsBlock instances to update with.</span>
<span class="sd">        avoid_strands : set of Strand, default None</span>
<span class="sd">            A set of strands to avoid in the update process.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any of the input arguments is not a StrandsBlock, or </span>
<span class="sd">            if avoid_strand is not a Strand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">StrandsBlock</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">others</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input arguments must be StrandsBlock instances&quot;</span><span class="p">)</span>
            
        <span class="c1"># check if the avoid_strand is a Strand instance</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">avoid_strands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> 
                <span class="ow">and</span> <span class="nb">any</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Strand</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">avoid_strands</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The avoid_strands must be a set of Strand instances&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">avoid_strands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">avoid_strands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># add the strands to the block</span>
        <span class="k">for</span> <span class="n">sb</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sb</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avoid_strands</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Luca Monari.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>